name: Build Pikapika Android APK

on:
  workflow_dispatch:          # 手动触发按钮（最实用）

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.7.3'   # 项目 README 推荐版本，避免兼容坑
          channel: 'stable'

      - name: Install Flutter dependencies
        run: flutter pub get

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.18'         # 项目兼容版本

      - name: Make scripts executable
        run: |
          chmod +x ./scripts/*.sh || true   # 确保所有脚本可执行，失败也不中断

      - name: Build Go bindings for Android (using project script)
        run: |
          if [ -f "./scripts/bind-android-arm64.sh" ]; then
            echo "Running project bind-android-arm64.sh"
            ./scripts/bind-android-arm64.sh
          else
            echo "bind-android-arm64.sh not found, trying bind-android-debug.sh as fallback"
            if [ -f "./scripts/bind-android-debug.sh" ]; then
              ./scripts/bind-android-debug.sh
            else
              echo "No bind script found! Check project scripts/ directory."
              exit 1
            fi
          fi

      - name: Build APK using project script (preferred)
        run: |
          if [ -f "./scripts/build-apk-arm64.sh" ]; then
            echo "Running project build-apk-arm64.sh"
            ./scripts/build-apk-arm64.sh
          else
            echo "build-apk-arm64.sh not found, fallback to flutter build"
            flutter build apk --release --split-per-abi
          fi

      - name: List built APK files for debug
        run: ls -la build/app/outputs/flutter-apk/ || true

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pikapika-release-apks
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/**/*.apk   # 覆盖可能的不同输出路径
          retention-days: 7
          if-no-files-found: warn       # 如果没找到文件，给警告但不失败
